import React, { useRef, useState, useEffect } from 'react';
import { motion, useScroll, useTransform } from 'framer-motion';
import { Sun, Moon } from 'lucide-react';
import { useTheme } from './ThemeContext';
import { useLanguage } from './LanguageContext'; // Added
import './Theme.css';

const ThemeBall = ({ dotRef, destRef, langDestRef }) => {
    const { setTheme, theme } = useTheme();
    const { toggleLanguage, language } = useLanguage();
    const [startPos, setStartPos] = useState({ x: 0, y: 0, width: 0, height: 0 });
    const [themeEndPos, setThemeEndPos] = useState({ x: 0, y: 0 });
    const [langEndPos, setLangEndPos] = useState({ x: 0, y: 0 });
    const [ready, setReady] = useState(false);
    const [menuOpen, setMenuOpen] = useState(false);

    const { scrollY } = useScroll();

    useEffect(() => {
        const updatePos = () => {
            if (dotRef.current) {
                const rect = dotRef.current.getBoundingClientRect();
                setStartPos({
                    x: rect.left,
                    y: rect.top,
                    width: rect.width || 6,
                    height: rect.height || 6
                });
            }

            // Theme Ball Dest
            if (destRef?.current) {
                const rect = destRef.current.getBoundingClientRect();
                setThemeEndPos({
                    x: rect.left + (rect.width / 2) - 16, // Center 32px
                    y: rect.top + (rect.height / 2) - 16
                });
            }

            // Language Ball Dest
            if (langDestRef?.current) {
                const rect = langDestRef.current.getBoundingClientRect();
                setLangEndPos({
                    x: rect.left + (rect.width / 2) - 16, // Center 32px
                    y: rect.top + (rect.height / 2) - 16
                });
            }

            setReady(true);
        };

        updatePos();
        window.addEventListener('resize', updatePos);
        return () => window.removeEventListener('resize', updatePos);
    }, [dotRef, destRef, langDestRef]);

    // Motion Logic
    // Both start at startPos.
    // They stay together until ~450 scroll.
    // At 450, they are both at "startPos" conceptually? No, they travel.
    // Actually, they travel together to some midpoint or just travel together to "near" the navbar, then split.
    // Simplest: 
    // ThemeBall: 0 -> 500: start -> themeEnd
    // LangBall: 0 -> 450: start -> themeEnd (follows theme ball)
    //           450 -> 500: themeEnd -> langEnd (splits off)
    // OR:
    // They both interpolate from Start to End, but LangBall's path is curved or clamped?
    // "Right before it nests it splits".
    // So for 0-80% scroll, they physically overlap and look like one ball.
    // 80-100%: They diverge.

    // Theme Ball path (Linear from dot to destination)
    const themeX = useTransform(scrollY, [0, 500], [startPos.x, themeEndPos.x]);
    const themeY = useTransform(scrollY, [0, 500], [startPos.y, themeEndPos.y]);

    // Lang Ball path - Follows Theme Ball until 450, then snaps to its own dest
    // To make it stick, map [0, 450] to [start.x, ThemeEndPos.x at 450?]
    // Wait, ThemeEndPos.x is the final value.
    // We want LangBall to be at the same position as ThemeBall at scroll=450.
    // At scroll=450, ThemeBall is at: start + (end-start)*0.9.
    // So LangBall should be there too.
    // Then at scroll=500, LangBall goes to LangEnd.

    // We can use a custom transform function for LangBall
    const langX = useTransform(scrollY, (y) => {
        const progress = Math.min(y / 500, 1);
        const splitPoint = 0.85; // Split at 85%

        // Position of Theme Ball at current progress
        const currentThemeX = startPos.x + (themeEndPos.x - startPos.x) * progress;

        if (progress < splitPoint) {
            return currentThemeX; // Stick together
        } else {
            // Mapping from 0.85 to 1.0
            // Range: currentThemeX (at 0.85) -> langEndPos.x
            const splitProgress = (progress - splitPoint) / (1 - splitPoint);
            // We need to interpolate from where we were (ThemePos at 0.85) to DragEnd
            const themeXAtSplit = startPos.x + (themeEndPos.x - startPos.x) * splitPoint;
            return themeXAtSplit + (langEndPos.x - themeXAtSplit) * splitProgress;
        }
    });

    const langY = useTransform(scrollY, (y) => {
        const progress = Math.min(y / 500, 1);
        const splitPoint = 0.85;
        const currentThemeY = startPos.y + (themeEndPos.y - startPos.y) * progress;

        if (progress < splitPoint) {
            return currentThemeY;
        } else {
            const splitProgress = (progress - splitPoint) / (1 - splitPoint);
            const themeYAtSplit = startPos.y + (themeEndPos.y - startPos.y) * splitPoint;
            return themeYAtSplit + (langEndPos.y - themeYAtSplit) * splitProgress;
        }
    });

    // Size
    const widthVal = useTransform(scrollY, [0, 500], [startPos.width || 6, 32]);
    const heightVal = useTransform(scrollY, [0, 500], [startPos.width || 6, 32]);

    const iconOpacity = useTransform(scrollY, [450, 500], [0, 1]);

    if (!ready) return null;

    const themes = [
        { id: 'light', color: '#ffffff', border: '#ddd' },
        { id: 'dark', color: '#0a0a0f', border: '#333' },
        { id: 'matrix', color: '#000000', border: '#00ff41' },
        { id: 'ocean', color: '#0f172a', border: '#38bdf8' },
        { id: 'sunset', color: '#2a1b3d', border: '#ff6b6b' },
        { id: 'cyberpunk', color: '#0b0d17', border: '#f700ff' },
        { id: 'forest', color: '#051405', border: '#4caf50' },
        { id: 'coffee', color: '#2c241b', border: '#ddb892' },
        { id: 'royal', color: '#1a0b2e', border: '#ffd700' },
        { id: 'synthwave', color: '#2b213a', border: '#b967ff' },
        { id: 'nordic', color: '#2e3440', border: '#88c0d0' },
        { id: 'earth', color: '#2b2621', border: '#bc6c25' },
        { id: 'midnight', color: '#020617', border: '#6366f1' },
        { id: 'minimal', color: '#ffffff', border: '#18181b' },
        { id: 'candy', color: '#fff0f5', border: '#ff91c8' },
    ];

    return (
        <>
            {/* SVG Filter for Gooey Effect */}
            <svg style={{ position: 'absolute', width: 0, height: 0 }}>
                <defs>
                    <filter id="goo">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="5" result="blur" />
                        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" />
                        <feComposite in="SourceGraphic" in2="goo" operator="atop" />
                    </filter>
                </defs>
            </svg>

            {/* Container applying the filter */}
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                width: '100%',
                height: '100%',
                pointerEvents: 'none',
                zIndex: 2000,
                filter: 'url(#goo)'
            }}>
                {/* Theme Ball Middle - The one that spawns */}
                <motion.div
                    className="theme-ball-main"
                    onClick={() => setMenuOpen(!menuOpen)}
                    style={{
                        position: 'fixed',
                        left: 0,
                        top: 0,
                        borderRadius: '50%',
                        backgroundColor: 'var(--accent-color)',
                        x: themeX,
                        y: themeY,
                        width: widthVal,
                        height: heightVal,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        pointerEvents: 'auto',
                        boxShadow: '0 4px 10px rgba(0,0,0,0.3)'
                    }}
                >
                    <motion.div style={{ opacity: iconOpacity, width: '60%', height: '60%', color: '#fff' }}>
                        {theme === 'light' ? <Moon size="100%" /> : <Sun size="100%" />}
                    </motion.div>
                </motion.div>

                {/* Language Ball - Spawns smoothly */}
                <motion.div
                    onClick={toggleLanguage}
                    style={{
                        position: 'fixed',
                        left: 0,
                        top: 0,
                        borderRadius: '50%',
                        backgroundColor: 'var(--accent-color)',
                        x: langX,
                        y: langY,
                        width: widthVal,
                        height: heightVal,
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        pointerEvents: 'auto',
                        boxShadow: '0 4px 10px rgba(0,0,0,0.3)'
                    }}
                >
                    <motion.div style={{ opacity: iconOpacity, color: '#fff', fontSize: '0.75rem', fontWeight: 'bold' }}>
                        {language === 'en' ? 'ZH' : 'EN'}
                    </motion.div>
                </motion.div>
            </div>

            {/* Menu Rendered Outside Filter to stay sharp? 
                Actually, if menu is child of "theme-ball-main", it inherits filter.
                We should render menu separately or use a Portal if issues arise.
                But user asked for the SPLIT effect on the buttons.
                Let's put the menu outside the filtered container.
            */}
            {menuOpen && (
                <motion.div
                    // ... menu animation ...
                    style={{
                        position: 'fixed', // Fixed to follow window
                        left: themeEndPos.x - 30, // Approximate alignment
                        top: themeEndPos.y + 25,
                        zIndex: 2001,
                        // ...
                        display: 'grid',
                        gridTemplateColumns: 'repeat(3, 1fr)',
                        gap: '10px',
                        background: 'rgba(20, 20, 30, 0.95)',
                        padding: '12px',
                        borderRadius: '16px',
                        boxShadow: '0 4px 20px rgba(0,0,0,0.6)',
                        border: '1px solid rgba(255,255,255,0.1)',
                        backdropFilter: 'blur(10px)',
                        minWidth: '90px'
                    }}
                >
                    {themes.map((t) => (
                        <div
                            key={t.id}
                            onClick={() => {
                                setTheme(t.id);
                                setMenuOpen(false);
                            }}
                            style={{
                                width: '22px', height: '22px', borderRadius: '50%',
                                backgroundColor: t.color, border: `2px solid ${t.border}`,
                                cursor: 'pointer', margin: 'auto',
                                boxShadow: theme === t.id ? `0 0 8px ${t.border}` : 'none'
                            }}
                        />
                    ))}
                </motion.div>
            )}
        </>
    );
};

export default ThemeBall;
